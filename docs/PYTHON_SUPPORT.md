<!-- Copyright © 2025 Lukas Bower -->
<!-- SPDX-License-Identifier: Apache-2.0 -->
<!-- Purpose: Document Cohesix Python client usage and backends. -->
<!-- Author: Lukas Bower -->
# Cohesix Python Support (Milestone 24)

The `cohesix` Python client is a **thin, non-authoritative** wrapper over existing Cohesix
console and filesystem semantics. It **does not introduce new control-plane behavior**; it
mirrors the same verbs, bounds, and error rules enforced by `cohsh` and Secure9P.

## Scope and guarantees
- **Non-authoritative**: all behavior maps to existing console/9P semantics.
- **Bounded**: limits are derived from manifest-backed defaults generated by `coh-rtc`.
- **Host-side only**: the client runs outside the VM.

## Where it lives
- **Source tree**: `tools/cohesix-py/`
- **Release bundle**: `python/cohesix-py/` (see bundle `QUICKSTART.md`)

## Backends
- **TcpBackend**: connects to the TCP console (`AUTH` + `ATTACH`), issues console verbs.
- **FilesystemBackend**: operates on a mounted Secure9P namespace (via `coh mount`).
- **MockBackend**: deterministic in-memory filesystem for tests/examples.

## Install (source tree)
```bash
python3 -m pip install -e tools/cohesix-py
```

## Quickstart (mock mode)
`--mock` runs the client against a deterministic in-memory backend. It is fast, requires no QEMU, and is ideal for CI and first‑run demos.
```bash
python3 tools/cohesix-py/examples/lease_run.py --mock
python3 tools/cohesix-py/examples/peft_roundtrip.py --mock
python3 tools/cohesix-py/examples/telemetry_write_pull.py --mock
```
Artifacts land under `out/examples/`.

## Live connection requirements (no `--mock`)
To run against a live Queen, you need:
- A running QEMU VM: `./qemu/run.sh`
- A valid console auth token (default `changeme` or set `COHSH_AUTH_TOKEN`)
- Any required host integrations (e.g., GPU bridge if using `/gpu`)

## Live TCP backend (Queen running)
1) Boot the VM (Mac host):
```bash
./qemu/run.sh
```
2) Run a Python example against the TCP console:
```bash
python3 tools/cohesix-py/examples/lease_run.py \
  --tcp-host 127.0.0.1 --tcp-port 31337
```
If your console auth token is not the default, set `COHSH_AUTH_TOKEN` before running.

## Filesystem backend (Secure9P mount)
1) Mount the namespace on the host (requires `coh mount`):
```bash
./bin/coh --host 127.0.0.1 --port 31337 mount --at /tmp/coh-mount
```
2) Use the filesystem backend against that mount:
```bash
python3 tools/cohesix-py/examples/lease_run.py --fs-root /tmp/coh-mount
```

## Bounds and defaults
The client enforces manifest-derived defaults emitted by `coh-rtc` (see
`docs/USERLAND_AND_CLI.md` → “Cohesix Python defaults”). These include:
- `secure9p.msize`, walk depth, and console line/JSON limits
- telemetry ingest caps
- registry and path allowlists

## Tests (parity)
The parity tests verify the Python client matches `cohsh` behavior byte-for-byte:
```bash
python3 -m pytest -k cohesix_parity tools/cohesix-py/tests/test_parity.py
```

## Troubleshooting
- `ERR AUTH`: set `COHSH_AUTH_TOKEN` (or `--auth-token` equivalents) to match the Queen.
- Empty `/gpu`: ensure the host GPU bridge integration is running; use `./bin/gpu-bridge-host --mock --list` for mock demos.
- `--mock` is the fastest path for demos and CI; live runs require a running Queen VM.

## Real-world use cases (examples)
These examples assume a live Queen VM unless you explicitly add `--mock`.

### 1) Edge telemetry ingestion → export bundle
Goal: push telemetry from edge hosts and pull a bounded export bundle for training.
```bash
python3 tools/cohesix-py/examples/telemetry_write_pull.py --tcp-host 127.0.0.1 --tcp-port 31337
```
Why this matters: proves append-only telemetry ingest and bounded export without adding new protocols.

### 2) Lease → run → release automation
Goal: validate GPU lease behavior before a deployment.
```bash
python3 tools/cohesix-py/examples/lease_run.py --tcp-host 127.0.0.1 --tcp-port 31337
```
Why this matters: ensures lease enforcement and breadcrumbs are consistent with `coh` and `cohsh` flows.

### 3) PEFT roundtrip from a training farm
Goal: export a training job, import adapter artifacts, and activate safely.
```bash
python3 tools/cohesix-py/examples/peft_roundtrip.py --tcp-host 127.0.0.1 --tcp-port 31337
```
Why this matters: demonstrates auditable adapter handling with explicit activation/rollback semantics.

### 4) Local operator tooling (TCP backend)
Goal: automate common operator checks using the same console semantics as `cohsh`.
```bash
python3 tools/cohesix-py/examples/lease_run.py --tcp-host 127.0.0.1 --tcp-port 31337
```
Why this matters: confirms the Python client is a thin wrapper over the live console, not a new control plane.

### 5) Filesystem backend for air‑gapped automation
Goal: operate via a mounted Secure9P namespace without TCP in the workflow.
```bash
./bin/coh --host 127.0.0.1 --port 31337 mount --at /tmp/coh-mount
python3 tools/cohesix-py/examples/lease_run.py --fs-root /tmp/coh-mount
```
Why this matters: keeps control‑plane access file‑shaped and auditable even in restricted environments.

## Design alignment
This client exists to lower adoption friction while preserving Cohesix’s core guarantees:
- no new protocols
- no hidden control planes
- deterministic, auditable behavior
