# Author: Lukas Bower
# Purpose: Exercise telemetry ring wraparound, quota rejection, and stale cursor handling.
attach queen
EXPECT OK
spawn heartbeat ticks=40 ttl_s=60
EXPECT OK
# Force ring wraparound with repeated appends (payload <= 96 chars).
echo wrap-0123456789012345678901234567890123456789012345678901234567890123456789012345678901234 > /worker/worker-1/telemetry
EXPECT OK
echo wrap-0123456789012345678901234567890123456789012345678901234567890123456789012345678901234 > /worker/worker-1/telemetry
EXPECT OK
echo wrap-0123456789012345678901234567890123456789012345678901234567890123456789012345678901234 > /worker/worker-1/telemetry
EXPECT OK
echo wrap-0123456789012345678901234567890123456789012345678901234567890123456789012345678901234 > /worker/worker-1/telemetry
EXPECT OK
echo wrap-0123456789012345678901234567890123456789012345678901234567890123456789012345678901234 > /worker/worker-1/telemetry
EXPECT OK
echo wrap-0123456789012345678901234567890123456789012345678901234567890123456789012345678901234 > /worker/worker-1/telemetry
EXPECT OK
echo wrap-0123456789012345678901234567890123456789012345678901234567890123456789012345678901234 > /worker/worker-1/telemetry
EXPECT OK
echo wrap-0123456789012345678901234567890123456789012345678901234567890123456789012345678901234 > /worker/worker-1/telemetry
EXPECT OK
echo wrap-0123456789012345678901234567890123456789012345678901234567890123456789012345678901234 > /worker/worker-1/telemetry
EXPECT OK
echo wrap-0123456789012345678901234567890123456789012345678901234567890123456789012345678901234 > /worker/worker-1/telemetry
EXPECT OK
echo wrap-0123456789012345678901234567890123456789012345678901234567890123456789012345678901234 > /worker/worker-1/telemetry
EXPECT OK
echo wrap-0123456789012345678901234567890123456789012345678901234567890123456789012345678901234 > /worker/worker-1/telemetry
EXPECT OK
WAIT 200
cat /log/queen.log
EXPECT SUBSTR telemetry ring wrap
cat /worker/worker-1/telemetry
EXPECT ERR
quit
