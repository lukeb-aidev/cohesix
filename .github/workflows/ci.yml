# CLASSIFICATION: COMMUNITY
# Filename: ci.yml v1.5
# Author: Lukas Bower
# Date Modified: 2025-09-11

name: Cohesix CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - uses: actions/setup-go@v4
        with:
          go-version: '1.22'
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y make
      - name: Run Rust build and tests
        id: rust
        run: |
          cargo build > rust_build.log 2>&1
          cargo test > rust_test.log 2>&1 || true
          pass=$(grep -o '[0-9]\+ passed' rust_test.log | awk '{s+=$1} END{print s+0}')
          fail=$(grep -o '[0-9]\+ failed' rust_test.log | awk '{s+=$1} END{print s+0}')
          echo "pass=$pass" >> "$GITHUB_OUTPUT"
          echo "fail=$fail" >> "$GITHUB_OUTPUT"
      - name: Run Python tests
        id: python
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pytest > python_test.log 2>&1 || true
          pass=$(grep -o '[0-9]\+ passed' python_test.log | awk '{s+=$1} END{print s+0}')
          fail=$(grep -o '[0-9]\+ failed' python_test.log | awk '{s+=$1} END{print s+0}')
          echo "pass=$pass" >> "$GITHUB_OUTPUT"
          echo "fail=$fail" >> "$GITHUB_OUTPUT"
      - name: Run Go tests
        id: go
        run: |
          GOWORK=$(pwd)/go/go.work go test ./... > go_test.log 2>&1 || true
          pass=$(grep -c '^ok' go_test.log || true)
          fail=$(grep -c '^FAIL' go_test.log || true)
          echo "pass=$pass" >> "$GITHUB_OUTPUT"
          echo "fail=$fail" >> "$GITHUB_OUTPUT"
      - name: Run make targets
        run: |
          make lint || true
          make test || true
          make build || true
      - name: Validation summary
        run: |
          echo "Rust: ${{ steps.rust.outputs.pass }} passed, ${{ steps.rust.outputs.fail }} failed"
          echo "Python: ${{ steps.python.outputs.pass }} passed, ${{ steps.python.outputs.fail }} failed"
          echo "Go: ${{ steps.go.outputs.pass }} passed, ${{ steps.go.outputs.fail }} failed"
