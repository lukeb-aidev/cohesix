# CLASSIFICATION: COMMUNITY
# Filename: ci.yml v1.32
# Author: Lukas Bower
# Date Modified: 2028-11-26

name: Cohesix CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  ci:
    defaults:
      run:
        shell: bash
        working-directory: workspace
    runs-on: ubuntu-22.04
  steps:
    - uses: actions/checkout@v4

    - name: Verify tag matches Cargo version
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        TAG=${GITHUB_REF#refs/tags/v}
        TOML_VERSION=$(grep '^version =' workspace/cohesix/Cargo.toml | head -n1 | cut -d '"' -f2)
        test "$TAG" = "$TOML_VERSION"

      - uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('workspace/Cargo.lock') }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          override: false
          components: rust-src

      - name: Install nightly toolchain
        run: rustup toolchain install nightly

      - name: Install aarch64 target
        run: rustup target add aarch64-unknown-none

      - name: Set seL4 env vars
        run: |
          echo "SEL4_INCLUDE=$(pwd)/../third_party/seL4/include" >> $GITHUB_ENV
          echo "SEL4_LIB_DIR=$(pwd)/../third_party/seL4/lib" >> $GITHUB_ENV

      - name: Validate Rust workspace
        working-directory: ..
        run: bash scripts/validate-crates.sh

      - name: Smoke build sel4-sys-extern-wrapper
        working-directory: workspace
        run: |
          cargo +nightly build \
            -p sel4-sys-extern-wrapper \
            --release \
            -Z build-std=core,alloc,compiler_builtins \
            -Z build-std-features=compiler-builtins-mem \
            --target=cohesix_root/sel4-aarch64.json

      - uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      - uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/.modcache
          key: ${{ runner.os }}-go-${{ hashFiles('go/go.mod', 'go/go.sum') }}

      - name: Build Rust components
        working-directory: workspace
        run: |
          log() { echo -e "\033[1;34m$1\033[0m"; }

          log "ðŸ”¨ Building crates for aarch64"
          cargo +nightly build --release --workspace \
            --exclude sel4-sys-extern-wrapper \
            --exclude cohesix_root \
            --target=cohesix_root/sel4-aarch64.json \
            -Z build-std=std,panic_abort
          cargo +nightly test --release --workspace \
            --exclude sel4-sys-extern-wrapper \
            --exclude cohesix_root \
            --target=cohesix_root/sel4-aarch64.json \
            -Z build-std=std,panic_abort
          log "âœ… Host crates built and tested"

          log "ðŸ”¨ Building sel4-sys-extern-wrapper (no-std, panic-abort)"
          cargo +nightly build -p sel4-sys-extern-wrapper --release \
            --target=cohesix_root/sel4-aarch64.json \
            -Z build-std=core,alloc,compiler_builtins \
            -Z build-std-features=compiler-builtins-mem
          log "âœ… sel4-sys-extern-wrapper built"

          log "ðŸ”¨ Building cohesix_root (no-std, panic-abort)"
          cargo +nightly build -p cohesix_root --release \
            --target=cohesix_root/sel4-aarch64.json \
            -Z build-std=core,alloc,compiler_builtins \
            -Z build-std-features=compiler-builtins-mem
          log "âœ… cohesix_root built"

          log "âœ… Rust components built with proper split targets"

      - name: Run Rust tests (aarch64)
        working-directory: workspace
        run: |
          cargo +nightly test --release --workspace \
            --exclude cohesix_root \
            --target=cohesix_root/sel4-aarch64.json \
            -Z build-std=std,panic_abort | tee rust_test_host.log

      - name: Run Go tests
        run: |
          GOWORK=$(pwd)/go/go.work go test ./... | tee go_test.log

      - name: Run Python tests
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install -r ../requirements.txt
          pytest -q | tee python_test.log

      - name: Cargo test compile
        working-directory: workspace
        run: |
          cargo +nightly test --workspace --no-run \
            --target=cohesix_root/sel4-aarch64.json \
            -Z build-std=std,panic_abort | tee rust_test_compile.log

      - name: Install QEMU for aarch64
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-aarch64

      - name: QEMU aarch64 boot test
        run: |
          BOOT_ARCH=aarch64 ci/qemu_boot_check.sh | tee qemu_boot.log

      - uses: actions/upload-artifact@v4
        with:
          name: qemu-boot-log
          path: qemu_boot.log


      - uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: |
            rust_test_host.log
            go_test.log
            python_test.log

      - name: Validation summary
        run: |
          echo "âœ… Cohesix CI completed. Review logs in the Artifacts tab."