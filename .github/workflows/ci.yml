# CLASSIFICATION: COMMUNITY
# Filename: ci.yml v1.4
# Author: Lukas Bower
# Date Modified: 2025-09-04

name: Cohesix CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            features: "secure9p"
            run_tests: true
          - target: x86_64-unknown-uefi
            features: "kernel_bin minimal_uefi"
            run_tests: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          target: ${{ matrix.target }}
      - name: Set RUSTFLAGS
        run: |
          if [ "${CUDA_ENABLED:-false}" != "true" ]; then
            echo "RUSTFLAGS=--cfg no_cuda" >> "$GITHUB_ENV"
          fi
      - name: Cargo build
        run: cargo build --release --target ${{ matrix.target }} --features "${{ matrix.features }}"
      - name: Cargo test
        if: matrix.run_tests
        run: cargo test --release --target ${{ matrix.target }} --features "${{ matrix.features }}"
      - name: Pytest
        if: matrix.run_tests
        run: |
          if [ -d tests ]; then
            pip install -r requirements.txt
            pytest tests/
          fi
      - name: Collect artifacts
        if: matrix.target == 'x86_64-unknown-uefi'
        run: |
          mkdir -p out/EFI/BOOT out/etc/cohesix out/roles
          cp target/${{ matrix.target }}/release/kernel.efi out/kernel.efi
          cp target/${{ matrix.target }}/release/init.efi out/init.efi
          cp target/${{ matrix.target }}/release/kernel.efi out/EFI/BOOT/bootx64.efi
          cp configs/roles/default.yaml out/etc/cohesix/config.yaml
          cp -a configs/roles/. out/roles/
      - name: Verify artifacts
        if: matrix.target == 'x86_64-unknown-uefi'
        run: |
          test -f out/kernel.efi
          test -f out/init.efi
          test -f out/EFI/BOOT/bootx64.efi
          test -f out/etc/cohesix/config.yaml
          test -d out/roles
      - uses: actions/upload-artifact@v4
        if: matrix.target == 'x86_64-unknown-uefi'
        with:
          name: cohesix-${{ matrix.target }}
          path: |
            out/init.efi
            out/EFI/BOOT/bootx64.efi
            out/etc/cohesix/config.yaml
            out/roles

  go:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
        with:
          go-version: '1.22'
      - name: Build
        run: go build ./...

  shell:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Shellcheck
        run: shellcheck test_all_arch.sh || true
