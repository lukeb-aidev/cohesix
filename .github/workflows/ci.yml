# CLASSIFICATION: COMMUNITY
# Filename: ci.yml v1.1
# Author: Lukas Bower
# Date Modified: 2025-07-16

name: Cohesix CI

on:
  push:
    branches: [ "main", "batch/**" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    env:
      COHROLE: ${{ matrix.role }}
      ENABLE_CUDA: ${{ matrix.cuda }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
            cuda: false
            role: DroneWorker
          - os: ubuntu-latest
            arch: aarch64
            cuda: false
            role: DroneWorker
          - os: ubuntu-latest
            arch: x86_64
            cuda: true
            role: DroneWorker

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1.0.7
        with:
          toolchain: stable
          profile: minimal
          override: true
          components: rustfmt, clippy

      - name: Cache cargo artefacts
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Rustfmt (style check)
        run: cargo fmt -- --check

      - name: Clippy (lint)
        run: cargo clippy --all-targets -- -D warnings

      - name: Unit & doc tests (sandboxed)
        run: |
          mkdir -p /mnt/data
          bwrap \
            --ro-bind /usr /usr \
            --ro-bind /bin /bin \
            --ro-bind /lib /lib \
            --ro-bind /lib64 /lib64 \
            --dev /dev \
            --proc /proc \
            --bind $(pwd) /workspace \
            --tmpfs /tmp \
            --bind /mnt/data /mnt/data \
            --chdir /workspace \
            bash -c "cargo test --all-targets --verbose"

      - name: Build (release)
        run: cargo build --all-targets --release --verbose

      - name: Build Cohbox
        run: make -f third_party/busybox/Makefile.coh

      - name: Test Cohbox (sandboxed)
        run: |
          bwrap \
            --ro-bind /usr /usr \
            --ro-bind /bin /bin \
            --ro-bind /lib /lib \
            --ro-bind /lib64 /lib64 \
            --dev /dev \
            --proc /proc \
            --bind $(pwd) /workspace \
            --tmpfs /tmp \
            --bind /mnt/data /mnt/data \
            --chdir /workspace \
            bash -c "./scripts/test_cohbox.sh"

      - name: Cross-arch test suite (sandboxed)
        run: |
          bwrap \
            --ro-bind /usr /usr \
            --ro-bind /bin /bin \
            --ro-bind /lib /lib \
            --ro-bind /lib64 /lib64 \
            --dev /dev \
            --proc /proc \
            --bind $(pwd) /workspace \
            --tmpfs /tmp \
            --bind /mnt/data /mnt/data \
            --chdir /workspace \
            bash -c "./test_all_arch.sh"

        - name: Replay physics trace (sandboxed)
          run: |
            bwrap \
              --ro-bind /usr /usr \
              --ro-bind /bin /bin \
              --ro-bind /lib /lib \
              --ro-bind /lib64 /lib64 \
              --dev /dev \
              --proc /proc \
              --bind $(pwd) /workspace \
              --tmpfs /tmp \
              --bind /mnt/data /mnt/data \
              --chdir /workspace \
              bash -c "python3 scripts/cohtrace.py replay examples/trace_example_physics.json > trace_replay.log && grep -q 'replay spawn' trace_replay.log"

        - name: Grype vulnerability scan
          run: docker run --rm -v $(pwd):/project anchore/grype /project

  hardware_boot:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Collect boot logs
        env:
          JETSON_HOST: ${{ secrets.JETSON_HOST }}
          PI_HOST: ${{ secrets.PI_HOST }}
        run: scripts/collect_boot_logs.sh

      - name: Checksum boot logs
        run: |
          sha256sum logs/*.log | tee boot_logs.sha256

      - name: Upload boot logs
        uses: actions/upload-artifact@v3
        with:
          name: boot-logs
          path: logs/*.log

      - name: Upload boot log checksums
        uses: actions/upload-artifact@v3
        with:
          name: boot-log-checksums
          path: boot_logs.sha256
