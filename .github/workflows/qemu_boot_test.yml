# CLASSIFICATION: COMMUNITY
# Filename: qemu_boot_test.yml v0.1
# Author: Lukas Bower
# Date Modified: 2028-11-21

name: QEMU Boot Test

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '**'

jobs:
  boot-test:
    runs-on: ubuntu-22.04
    env:
      SEL4_ARCH: aarch64
    defaults:
      run:
        shell: bash
        working-directory: workspace
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          override: true
          components: rust-src
      - name: Install QEMU
        run: sudo apt-get update && sudo apt-get install -y qemu-system-aarch64
      - name: Build root
        run: |
          cargo +nightly build -p sel4-sys-extern-wrapper --release \
            --target=cohesix_root/sel4-aarch64.json \
            -Z build-std=core,alloc,compiler_builtins \
            -Z build-std-features=compiler-builtins-mem
          cargo +nightly build -p cohesix_root --release \
            --target=cohesix_root/sel4-aarch64.json \
            -Z build-std=core,alloc,compiler_builtins \
            -Z build-std-features=compiler-builtins-mem
      - name: QEMU boot
        run: |
          qemu-system-aarch64 -machine virt -cpu cortex-a57 -m 1024 \
            -nographic -serial mon:stdio \
            -kernel target/sel4-aarch64/release/cohesix_root \
            -no-reboot 2>&1 | tee qemu.log &
          pid=$!
          for i in {1..40}; do
            if grep -q 'Cohesix init complete' qemu.log 2>/dev/null; then
              kill $pid || true
              exit 0
            fi
            if ! ps -p $pid >/dev/null 2>&1; then
              break
            fi
            sleep 1
          done
          kill $pid || true
          tail -n 20 qemu.log
          exit 1
